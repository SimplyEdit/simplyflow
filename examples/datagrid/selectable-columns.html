<!doctype html>
<meta charset="utf-8">
<title>datatable with selectable columns</title>
<link rel="stylesheet" href="../css/ds.css">
<link rel="stylesheet" href="../css/source.css">
<link rel="stylesheet" href="datatable.css">
<script type="module">
  if (!("anchorName" in document.documentElement.style)) {
    import("https://unpkg.com/@oddbird/css-anchor-positioning");
  }
</script>
<main>
	<h1>Datatable with selectable columns</h1>
	<button class="ds-dropdown ds-dropdown ds-datatable-column-select" popovertarget="menu" popovertargetaction="toggle">
		<svg class="ds-icon ds-icon-feather">
			<use xlink:href="../css/feather-sprite.svg#plus"></use>
		</svg>
	</button>
	<nav class="ds-datatable-column-toggle ds-dropdown-nav ds-dropdown-right ds-align-left" popover id="menu">
		<ul class="ds-dropdown-list" data-flow-map="users.state.options.columns">
			<template>
				<li class="ds-dropdown-item" data-simply-command="dsToggleColumn">
					<label>
						<input type="checkbox" value=":empty" data-flow-field="hidden">
						<span data-flow-field="name"></span>
					</label>
				</li>
			</template>
		</ul>
	</nav>
	<table class="ds-datatable ds-datatable-sticky-header ds-datatable-rulers">
	<thead>
		<tr data-flow-map="users.state.options.columns">
			<template data-flow-field="hidden" data-flow-match=":empty">
				<th data-flow-field="name"></th>
			</template>
		</tr>
	</thead>
	<tbody data-flow-list="users.view.current">
		<template>
			<tr data-flow-map=":value">
				<template>
					<td data-flow-field=":value"></td>
				</template>
			</tr>
		</template>
	</tbody>
	</table>
</main>

<script src="https://cdn.jsdelivr.net/npm/simplyview/dist/simply.everything.js"></script>
<script class="source" type="module">
	import {signal, effect, batch, trace} from '../../src/state.mjs'
	import {bind, trace as tracePath} from '../../src/bind.mjs'
	import {model, paging, sort, filter, columns, scroll} from '../../src/model.mjs'

	window.trace = trace
	window.tracePath = tracePath

	async function main() {
		let response = await fetch('users.json')
		let users = await response.json()

		const usersModel = model({
			data: users,
			options: {

			}
		})

		// adds the effect to render visible columns
		usersModel.addEffect(columns({
			first_name: {
				name: 'First Name'
			},
			last_name: {
				name: 'Last Name'
			},
			email: {
				name: 'E-mail'
			},
			city: {
				name: 'City',
				hidden: true
			},
			street: {
				name: 'Address',
				hidden: true
			},
			gender_abbr: {
				name: 'Gender',
				hidden: true
			},
			username: {
				name: 'Username',
				hidden: true
			}
		}))

		usersModel.container = document.body
		// set up databinding to render the users list
		bind({
			container: usersModel.container,
			attribute: 'data-flow',
			root: {
				users: usersModel
			}
		})

		// add commands to handle user interaction
		simply.command({
			app: usersModel,
			commands: {
				dsToggleColumnSelect: function(el, value) {
					el.querySelector('.ds-datatable-column-toggle').classList.toggle('ds-selected')
				},
				dsToggleColumn: function(el, value) {
					const key = el.dataset.flowKey
					const columns = this.state.options.columns
					columns[key].hidden = columns[key].hidden ? 0 : 1
				}
			}
		})

		// make the usersModel available in the console
		window.usersModel = usersModel
	}

	main()
</script>