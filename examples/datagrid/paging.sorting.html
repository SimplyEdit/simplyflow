<!doctype html>
<meta charset="utf-8">
<title>datatable</title>
<link rel="stylesheet" href="../css/ds.css">
<link rel="stylesheet" href="../css/source.css">
<link rel="stylesheet" href="datatable.css">
<script type="module">
  if (!("anchorName" in document.documentElement.style)) {
    import("https://unpkg.com/@oddbird/css-anchor-positioning");
  }
</script>
<main>

<nav class="ds-buttonbar ds-align-right">
	<button data-simply-command="pagePrev" class="ds-button"><svg class="ds-icon ds-icon-feather">
			<use xlink:href="../css/feather-sprite.svg#chevron-left"></use>
		</svg></button>
	<span data-flow-field="numbers.state.options.paging.page"></span> /
	<span data-flow-field="numbers.state.options.paging.max"></span>
	<button data-simply-command="pageNext" class="ds-button"><svg class="ds-icon ds-icon-feather">
			<use xlink:href="../css/feather-sprite.svg#chevron-right"></use>
		</svg></button>
</nav>
<h1>Datatable</h1>
<div class="ds-datatable-main">
	<table class="ds-datatable ds-datatable-sticky-header ds-datatable-rulers">
	<thead>
		<tr data-flow-list="columns">
			<template>
				<th data-simply-command="toggleSort" data-flow-field=":value"></th>
			</template>
		</tr>
	</thead>
	<tbody data-flow-list="numbers.view.current">
		<template>
			<tr data-flow-map=":value">
				<template>
					<td data-flow-field=":value"></td>
				</template>
			</tr>
		</template>
	</tbody>
	</table>
</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/simplyview/dist/simply.everything.js"></script>
<script class="source" type="module">
	import {signal, effect, batch} from '../../src/state.mjs'
	import {bind} from '../../src/bind.mjs'
	import {model, paging, sort, filter, columns} from '../../src/model.mjs'
	
	// generate a random list of numbers
	const data = []
	for (let i=0; i<110; i++) {
		data.push({id:i,value:Math.floor(Math.random()*1000)})
	}

	// create a new SimplyFlowModel from it
	const numbersModel = model({
		data,
		options: {
		}
	})

	// adds a sort effect, this must come before
	// the paging effect, since the content of each
	// page depends on the sort order of the entire list
	numbersModel.addEffect(sort({ sortBy: 'value'}))

	// adds a paging effect
	numbersModel.addEffect(paging({
		pageSize: 25
	}))

	numbersModel.container = document.body
	// set up databinding to render the numbers list
	bind({
		container: numbersModel.container,
		attribute: 'data-flow',
		root: {
			numbers: numbersModel,
			columns: ['ID','Value']
		}
	})

	// add commands to handle user interaction
	simply.command({
		app: numbersModel,
		commands: {
			pagePrev: function(el, value) {
				this.state.options.paging.page--
			},
			pageNext: function(el, value) {
				this.state.options.paging.page++
			},
			toggleSort: function(el, value) {
				batch(() => {
					const sortBy = el.innerText.trim().toLowerCase()
					this.state.options.sort.sortBy = sortBy
					const dir = this.state.options.sort.direction
					if (dir=='asc') {
						this.state.options.sort.direction = 'desc'
					} else {
						this.state.options.sort.direction = 'asc'
					}
				})
			}
		}
	})

	// update the sort indicators in the column on changes
	let lastSortColumn = null
	effect(() => {
		const sortBy = numbersModel.state.options.sort.sortBy
		const sortDirection = numbersModel.state.options.sort.direction
		if (lastSortColumn) {
			lastSortColumn.classList.remove('ds-datatable-sorted-ascending')
			lastSortColumn.classList.remove('ds-datatable-sorted-descending')
		}
		lastSortColumn = numbersModel.container.querySelector(`th[data-flow-key="${sortBy}"]`)
		if (lastSortColumn) {
			lastSortColumn.classList.add(`ds-datatable-sorted-${sortDirection}ending`)
		}
	})

	// make the numbersModel available in the console
	window.numbersModel = numbersModel
	
</script>