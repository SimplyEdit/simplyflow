<!doctype html>
<meta charset="utf-8">
<title>datatable</title>
<link rel="stylesheet" href="../css/ds.css">
<link rel="stylesheet" href="../css/source.css">
<link rel="stylesheet" href="datatable.css">
<script type="importmap">
	{
		"imports": {
			"simplyflow/": "../../"
		}
	}
</script>
<script type="module">
  if (!("anchorName" in document.documentElement.style)) {
    import("https://unpkg.com/@oddbird/css-anchor-positioning");
  }
</script>
<main>

<h1>Datatable</h1>
<div class="ds-datatable-main">
	<table class="ds-datatable ds-datatable-sticky-header ds-datatable-rulers">
	<thead>
		<tr data-flow-map="options.columns">
			<template data-flow-field="hidden" data-flow-match=":empty">
				<th>
					<span data-flow-field="name"></span>
          <button class="ds-button ds-button-naked ds-dropdown" data-simply-command="toggleFilter">
           	<svg class="ds-icon ds-icon-feather">
            	<use xlink:href="../css/feather-sprite.svg#filter"></use>
          	</svg>
          </button>
				  <div class="ds-datatable-filter">
				    <input type="text" placeholder="filter" data-simply-command="filter" data-simply-immediate=1>
				  </div>
				</th>
			</template>
		</tr>
	</thead>
	<tbody data-flow-list="users.current">
		<template>
			<tr data-flow-map=":value">
				<template>
					<td data-flow-field=":value"></td>
				</template>
			</tr>
		</template>
	</tbody>
	</table>
</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/simplyview/dist/simply.everything.js"></script>
<script class="source" type="module">
	import {signal, effect, batch} from 'simplyflow/src/state.mjs'
	import {bind} from 'simplyflow/src/bind.mjs'
	import {model, paging, sort, filter, columns} from 'simplyflow/src/model.mjs'
	
	async function main() {
		let response = await fetch('users.json')
		let users = await response.json()

		const usersModel = model({
			data: users,
			options: {}
		})

		usersModel.addEffect(columns({
			first_name: {
				name: 'First Name'
			},
			last_name: {
				name: 'Last Name'
			},
			email: {
				name: 'E-mail'
			},
			city: {
				name: 'City',
				hidden: true
			},
			street: {
				name: 'Address',
				hidden: true
			},
			gender_abbr: {
				name: 'Gender',
				hidden: true
			},
			username: {
				name: 'Username',
				hidden: true
			}		
		}))


		usersModel.addEffect(filter({
			name: 'propertyFilter',
			filters: {
				'last_name': /^A/i
			},
			enabled: true,
			matches: function(row) {
				for (let property in this.filters) {
					let filterBy = this.filters[property]
					if (filterBy && !row[property].match(filterBy[Symbol.xRay])) {
						return false
					}
				}
				return true
			}
		}))

		const usersApp = simply.app({
			commands: {
				filter: function(el,value) {
					// find property name
					const property = el.closest('[data-flow-key').dataset.flowKey
					// set column filter
					usersModel.state.options.propertyFilter.filters[property] = new RegExp(value, 'i')
				},
				toggleFilter: function(el, value) {
					const filter = el.parentElement.querySelector('.ds-datatable-filter')
					if (filter.style.display=='block') {
						filter.style.display = 'none'
					} else {
						filter.style.display = 'block'
						filter.querySelector('input').focus()
					}
				}
			},
			state: signal({
				users: usersModel.view,
				options: usersModel.state.options
			})
		})

		bind({
			attribute: 'data-flow',
			root: usersApp.state
		})

		simply.activate.addListener('linkpopover', function() {
			const popover = this.parentElement.querySelector('.ds-dropdown-nav')
			if (!popover) {
				console.error('no popover found to link', this)
				return
			}
			if (!popover.id) {
				popover.id = 'id_'+Math.random().toString(36).substring(2,4)
			}
			this.setAttribute('popovertarget', popover.id)
		})


		// make the numbersModel available in the console
		window.usersModel = usersModel
		window.usersApp = usersApp
	}
	main()	


</script>